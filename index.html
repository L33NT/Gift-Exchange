<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>礼物兑换系统</title>
<style>
  body {
    font-family: "微软雅黑", sans-serif;
    margin: 0; padding: 0; background: #f9f9f9;
    display: flex; flex-direction: column; align-items: center;
  }
  main {
    max-width: 960px; width: 100%; padding: 10px;
  }
  h1, h2 {
    text-align: center; color: #333;
  }
  #login-section {
    margin-top: 40px;
    background: white; padding: 20px; border-radius: 6px;
    box-shadow: 0 0 8px #ccc;
    width: 300px;
  }
  #login-section input, #login-section button {
    width: 100%; padding: 8px; margin: 6px 0;
    font-size: 16px; box-sizing: border-box;
  }
  #login-section button {
    cursor: pointer; background: #28a745; color: white;
    border: none; border-radius: 4px;
  }
  #login-error {
    color: red; height: 18px; font-size: 14px;
  }
  .hidden { display: none; }
  #app {
    display: none;
    width: 100%;
  }
  .flex-row {
    display: flex; align-items: center; gap: 10px;
  }
  .gift-item {
    border: 1px solid #ddd; background: white;
    padding: 10px; margin-bottom: 12px;
    border-radius: 6px;
    box-shadow: 0 1px 3px #eee;
  }
  .gift-item img {
    width: 100px; height: 80px; object-fit: contain;
    border: 1px solid #ccc; border-radius: 4px;
    margin-right: 10px;
  }
  .gift-options button {
    margin-right: 6px; margin-top: 6px;
    cursor: pointer; padding: 4px 8px;
    border: 1px solid #aaa; border-radius: 3px;
    background: #f5f5f5;
  }
  .gift-options button:hover {
    background: #aaf;
    border-color: #448;
  }
  button {
    cursor: pointer; padding: 6px 12px;
    border-radius: 4px; border: 1px solid #666;
    background: #eee;
  }
  button:hover {
    background: #ccc;
  }
  #admin-section {
    margin-top: 20px;
    background: #fffbe6; padding: 12px;
    border-radius: 6px;
    box-shadow: 0 0 6px #dda;
  }
  label {
    display: block;
    margin-top: 8px;
  }
  input[type="text"], input[type="number"] {
    width: 100%; padding: 6px; box-sizing: border-box;
  }
  table {
    width: 100%; border-collapse: collapse; margin-top: 12px;
  }
  th, td {
    border: 1px solid #ccc; padding: 6px; text-align: center;
  }
  @media(max-width: 600px) {
    #login-section, main {
      width: 95%;
    }
    .gift-item {
      flex-direction: column;
      align-items: flex-start;
    }
    .gift-item img {
      margin-bottom: 8px;
    }
  }
</style>
</head>
<body>
<main>
  <h1>礼物兑换系统</h1>

  <!-- 登录区域 -->
  <section id="login-section">
    <h2>用户登录</h2>
    <input type="text" id="login-nickname" placeholder="请输入昵称" autocomplete="off" />
    <input type="password" id="login-password" placeholder="管理员密码" class="hidden" autocomplete="off" />
    <button id="btn-login">登录</button>
    <p class="error" id="login-error"></p>
  </section>

  <!-- 主应用 -->
  <section id="app">
    <div>
      <strong>当前用户：</strong><span id="current-user"></span>
      &nbsp;&nbsp;&nbsp;
      <strong>积分：</strong><span id="current-points">0</span>
      &nbsp;&nbsp;&nbsp;
      <button id="btn-logout">退出登录</button>
    </div>

    <hr />

    <!-- 礼物列表 -->
    <section>
      <h2>可兑换礼物</h2>
      <div id="gift-list"></div>
    </section>

    <hr />

    <!-- 兑换记录 -->
    <section>
      <h2>兑换记录</h2>
      <table>
        <thead>
          <tr><th>时间</th><th>礼物</th><th>选项</th><th>积分</th></tr>
        </thead>
        <tbody id="record-table-body"></tbody>
      </table>
    </section>

    <!-- 管理员面板 -->
    <section id="admin-section" class="hidden">
      <h2>管理员面板</h2>

      <!-- 积分管理 -->
      <div>
        <h3>用户积分管理</h3>
        <label>选择用户：
          <select id="user-select"></select>
        </label>
        <label>积分数：
          <input type="number" id="user-points-input" min="0" />
        </label>
        <button id="btn-update-points">更新积分</button>
      </div>

      <hr />

      <!-- 礼物管理 -->
      <div>
        <h3>礼物管理</h3>
        <label>名称：
          <input type="text" id="gift-name-input" placeholder="礼物名称" />
        </label>
        <label>图片链接：
          <input type="text" id="gift-img-input" placeholder="图片 URL" />
        </label>
        <label>积分：
          <input type="number" id="gift-points-input" min="1" />
        </label>
        <label>库存：
          <input type="number" id="gift-stock-input" min="0" />
        </label>
        <label>选项（可选，逗号分隔）：
          <input type="text" id="gift-options-input" placeholder="如 红,蓝,绿 或 A,B,C" />
        </label>
        <button id="btn-add-gift">添加礼物</button>

        <h4>礼物列表</h4>
        <div id="admin-gift-list"></div>
      </div>
    </section>
  </section>
</main>

<script>
  // 常量
  const ADMIN_NAME = 'admin';
  const ADMIN_PASSWORD = 'admin123';

  // 页面元素
  const loginSection = document.getElementById('login-section');
  const loginNickname = document.getElementById('login-nickname');
  const loginPassword = document.getElementById('login-password');
  const btnLogin = document.getElementById('btn-login');
  const loginError = document.getElementById('login-error');

  const appSection = document.getElementById('app');
  const currentUserSpan = document.getElementById('current-user');
  const currentPointsSpan = document.getElementById('current-points');
  const btnLogout = document.getElementById('btn-logout');

  const giftListDiv = document.getElementById('gift-list');
  const recordTableBody = document.getElementById('record-table-body');

  const adminSection = document.getElementById('admin-section');
  const userSelect = document.getElementById('user-select');
  const userPointsInput = document.getElementById('user-points-input');
  const btnUpdatePoints = document.getElementById('btn-update-points');

  const giftNameInput = document.getElementById('gift-name-input');
  const giftImgInput = document.getElementById('gift-img-input');
  const giftPointsInput = document.getElementById('gift-points-input');
  const giftStockInput = document.getElementById('gift-stock-input');
  const giftOptionsInput = document.getElementById('gift-options-input');
  const btnAddGift = document.getElementById('btn-add-gift');

  // 数据变量
  let currentUser = null;
  let gifts = [];
  let userPoints = {};
  let records = [];

  // --- 本地存储 key ---
  const LS_KEYS = {
    gifts: 'gift-exchange-gifts',
    points: 'gift-exchange-points',
    records: 'gift-exchange-records'
  };

  // --- 保存函数 ---
  function saveGifts() {
    localStorage.setItem(LS_KEYS.gifts, JSON.stringify(gifts));
  }
  function savePoints() {
    localStorage.setItem(LS_KEYS.points, JSON.stringify(userPoints));
  }
  function saveRecords() {
    localStorage.setItem(LS_KEYS.records, JSON.stringify(records));
  }

  // --- 读取函数 ---
  function loadGifts() {
    const v = localStorage.getItem(LS_KEYS.gifts);
    if (v) gifts = JSON.parse(v);
  }
  function loadPoints() {
    const v = localStorage.getItem(LS_KEYS.points);
    if (v) userPoints = JSON.parse(v);
  }
  function loadRecords() {
    const v = localStorage.getItem(LS_KEYS.records);
    if (v) records = JSON.parse(v);
  }

  // --- 初始化 ---
  function init() {
    loadGifts();
    loadPoints();
    loadRecords();
    renderGiftList();
    renderRecords();
    renderAdminGiftList();
    renderUserSelect();
  }

  // --- 登录成功后显示主界面 ---
  function showMain() {
    loginSection.style.display = 'none';
    appSection.style.display = 'block';
    currentUserSpan.textContent = currentUser;
    updatePointsDisplay();

    if (currentUser.toLowerCase() === ADMIN_NAME) {
      adminSection.classList.remove('hidden');
    } else {
      adminSection.classList.add('hidden');
    }
  }

  // --- 更新积分显示 ---
  function updatePointsDisplay() {
    currentPointsSpan.textContent = userPoints[currentUser] ?? 0;
  }

  // --- 渲染礼物列表 ---
  function renderGiftList() {
    giftListDiv.innerHTML = '';
    if (gifts.length === 0) {
      giftListDiv.textContent = '暂无礼物';
      return;
    }

    gifts.forEach(g => {
      const div = document.createElement('div');
      div.className = 'gift-item flex-row';

      const img = document.createElement('img');
      img.src = g.img || '';
      img.alt = g.name;
      div.appendChild(img);

      const info = document.createElement('div');
      info.style.flex = '1';

      info.innerHTML = `<strong>${g.name}</strong><br/>积分: ${g.points}<br/>库存: ${g.stock}`;

      // 如果有选项
      if (g.options && g.options.length > 0) {
        const optDiv = document.createElement('div');
        optDiv.className = 'gift-options';
        g.options.forEach(o => {
          const btn = document.createElement('button');
          btn.textContent = o;
          btn.onclick = () => {
            [...optDiv.children].forEach(b => b.style.backgroundColor = '');
            btn.style.backgroundColor = '#aaf';
            btn.dataset.selected = 'true';
          };
          optDiv.appendChild(btn);
        });
        info.appendChild(optDiv);
      }

      div.appendChild(info);

      const btnExchange = document.createElement('button');
      btnExchange.textContent = '兑换';
      btnExchange.disabled = (userPoints[currentUser] ?? 0) < g.points || g.stock <= 0;
      btnExchange.onclick = () => {
        // 选项判断
        let selectedOption = '';
        if (g.options && g.options.length > 0) {
          const optDiv = div.querySelector('.gift-options');
          const selectedBtn = optDiv ? [...optDiv.children].find(b => b.dataset.selected === 'true') : null;
          if (!selectedBtn) {
            alert('请选择礼物选项');
            return;
          }
          selectedOption = selectedBtn.textContent;
        }

        // 扣积分，减库存
        userPoints[currentUser] -= g.points;
        g.stock--;
        savePoints();
        saveGifts();

        // 记录兑换
        records.push({
          user: currentUser,
          time: new Date().toLocaleString(),
          giftName: g.name,
          option: selectedOption || '',
          points: g.points,
        });
        saveRecords();
        renderRecords();
        renderGiftList();
        alert('兑换成功！');
      };
      div.appendChild(btnExchange);

      giftListDiv.appendChild(div);
    });
  }

  // --- 渲染兑换记录 ---
  function renderRecords() {
    recordTableBody.innerHTML = '';
    const userRecords = records.filter(r => r.user === currentUser);
    if (userRecords.length === 0) {
      recordTableBody.innerHTML = '<tr><td colspan="4">无兑换记录</td></tr>';
      return;
    }
    userRecords.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.time}</td><td>${r.giftName}</td><td>${r.option}</td><td>${r.points}</td>`;
      recordTableBody.appendChild(tr);
    });
  }

  // --- 渲染管理员礼物列表 ---
  function renderAdminGiftList() {
    const container = document.getElementById('admin-gift-list');
    container.innerHTML = '';
    if (gifts.length === 0) {
      container.textContent = '暂无礼物';
      return;
    }

    gifts.forEach(g => {
      const div = document.createElement('div');
      div.className = 'gift-item flex-row';

      const img = document.createElement('img');
      img.src = g.img || '';
      img.alt = g.name;
      div.appendChild(img);

      const info = document.createElement('div');
      info.style.flex = '1';
      info.innerHTML = `<strong>${g.name}</strong><br/>积分: ${g.points}<br/>库存: ${g.stock}<br/>选项: ${g.options.join(', ') || '无'}`;
      div.appendChild(info);

      const btnDelete = document.createElement('button');
      btnDelete.textContent = '删除';
      btnDelete.onclick = () => {
        if (confirm(`确定删除礼物 "${g.name}" 吗？`)) {
          gifts = gifts.filter(x => x.id !== g.id);
          saveGifts();
          renderGiftList();
          renderAdminGiftList();
        }
      };
      div.appendChild(btnDelete);

      container.appendChild(div);
    });
  }

  // --- 渲染用户下拉列表 ---
  function renderUserSelect() {
    userSelect.innerHTML = '';
    Object.keys(userPoints).forEach(u => {
      const opt = document.createElement('option');
      opt.value = u;
      opt.textContent = u;
      userSelect.appendChild(opt);
    });
    userSelect.value = currentUser;
    userPointsInput.value = userPoints[currentUser] ?? 0;
  }

  // --- 事件绑定 ---
  btnLogin.onclick = () => {
    const nick = loginNickname.value.trim();
    const pw = loginPassword.value;
    if (!nick) {
      loginError.textContent = '请输入昵称';
      return;
    }
    if (nick.toLowerCase() === ADMIN_NAME) {
      if (pw !== ADMIN_PASSWORD) {
        loginError.textContent = '管理员密码错误';
        return;
      }
    }
    loginError.textContent = '';

    if (!(nick in userPoints)) {
      userPoints[nick] = 0;
      savePoints();
    }
    currentUser = nick;
    loginNickname.value = '';
    loginPassword.value = '';
    loginPassword.classList.add('hidden');

    showMain();
  };

  loginNickname.oninput = () => {
    if (loginNickname.value.trim().toLowerCase() === ADMIN_NAME) {
      loginPassword.classList.remove('hidden');
    } else {
      loginPassword.classList.add('hidden');
      loginPassword.value = '';
      loginError.textContent = '';
    }
  };

  btnLogout.onclick = () => {
    currentUser = null;
    appSection.style.display = 'none';
    loginSection.style.display = 'block';
  };

  btnAddGift.onclick = () => {
    const name = giftNameInput.value.trim();
    const img = giftImgInput.value.trim();
    const points = Number(giftPointsInput.value);
    const stock = Number(giftStockInput.value);
    const optionsText = giftOptionsInput.value.trim();

    if (!name || !img || isNaN(points) || points <= 0 || isNaN(stock) || stock < 0) {
      alert('请正确填写礼物名称、图片链接、积分和库存');
      return;
    }

    const options = optionsText ? optionsText.split(',').map(s => s.trim()).filter(s => s) : [];

    // 新礼物id
    const newId = gifts.length > 0 ? Math.max(...gifts.map(g => g.id)) + 1 : 1;

    gifts.push({
      id: newId,
      name,
      img,
      points,
      stock,
      options,
    });

    saveGifts();
    renderGiftList();
    renderAdminGiftList();

    giftNameInput.value = '';
    giftImgInput.value = '';
    giftPointsInput.value = '';
    giftStockInput.value = '';
    giftOptionsInput.value = '';
  };

  btnUpdatePoints.onclick = () => {
    const selectedUser = userSelect.value;
    const points = Number(userPointsInput.value);
    if (!selectedUser) {
      alert('请选择用户');
      return;
    }
    if (isNaN(points) || points < 0) {
      alert('请输入正确的积分数');
      return;
    }
    userPoints[selectedUser] = points;
    savePoints();
    if (selectedUser === currentUser) {
      updatePointsDisplay();
    }
    alert('积分更新成功');
  };

  userSelect.onchange = () => {
    const u = userSelect.value;
    userPointsInput.value = userPoints[u] ?? 0;
  };

  // 初始化加载
  init();
</script>
</body>
</html>
